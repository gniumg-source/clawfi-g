---
import LayoutCommon from '../app/LayoutCommon.astro';
---

<LayoutCommon>
	<div class="min-h-screen flex items-center justify-center p-4">
		<div class="w-full max-w-md animate-fadeIn">
			<!-- Logo -->
			<div class="flex justify-center mb-10">
				<div class="flex flex-col items-center gap-3">
					<img src="/logo.png" alt="ClawFi" class="h-16 w-auto" />
					<p class="text-sm text-white/50">All-Access Crypto Intelligence</p>
				</div>
			</div>

			<!-- Auth Form - Liquid Glass Card -->
			<div class="glass-elevated p-8">
				<!-- Tab Buttons - Pill style -->
				<div class="flex mb-8 p-1 rounded-full bg-white/5">
					<button
						id="tab-signin"
						type="button"
						class="flex-1 py-2.5 px-4 text-sm font-medium rounded-full transition-all btn-glass-primary"
					>
						Sign In
					</button>
					<button
						id="tab-signup"
						type="button"
						class="flex-1 py-2.5 px-4 text-sm font-medium rounded-full transition-all text-white/50 hover:text-white"
					>
						Sign Up
					</button>
				</div>

				<!-- Messages -->
				<div id="error-message" class="hidden mb-6 p-4 rounded-2xl bg-[#FF453A]/15 border border-[#FF453A]/30 text-[#FF6961] text-sm"></div>
				<div id="success-message" class="hidden mb-6 p-4 rounded-2xl bg-[#30D158]/15 border border-[#30D158]/30 text-[#30D158] text-sm"></div>

				<!-- Sign In Form -->
				<form id="login-form" class="space-y-5">
					<div>
						<label for="login-email" class="block text-sm font-medium text-white/70 mb-2">Email</label>
						<input
							type="email"
							id="login-email"
							name="email"
							class="input-glass"
							placeholder="you@example.com"
							required
						/>
					</div>
					
					<div>
						<label for="login-password" class="block text-sm font-medium text-white/70 mb-2">Password</label>
						<input
							type="password"
							id="login-password"
							name="password"
							class="input-glass"
							placeholder="••••••••"
							required
						/>
					</div>

					<button
						type="submit"
						id="login-btn"
						class="w-full btn-glass btn-glass-primary py-3 flex items-center justify-center gap-2"
					>
						<span id="login-btn-text">Sign In</span>
						<svg id="login-btn-spinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
							<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
							<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
						</svg>
					</button>
				</form>

				<!-- Sign Up Form -->
				<form id="register-form" class="hidden space-y-5">
					<div>
						<label for="register-name" class="block text-sm font-medium text-white/70 mb-2">Name <span class="text-white/30">(optional)</span></label>
						<input
							type="text"
							id="register-name"
							name="name"
							class="input-glass"
							placeholder="Your name"
						/>
					</div>

					<div>
						<label for="register-email" class="block text-sm font-medium text-white/70 mb-2">Email</label>
						<input
							type="email"
							id="register-email"
							name="email"
							class="input-glass"
							placeholder="you@example.com"
							required
						/>
					</div>
					
					<div>
						<label for="register-password" class="block text-sm font-medium text-white/70 mb-2">Password</label>
						<input
							type="password"
							id="register-password"
							name="password"
							class="input-glass"
							placeholder="Minimum 8 characters"
							minlength="8"
							required
						/>
					</div>

					<div>
						<label for="register-confirm" class="block text-sm font-medium text-white/70 mb-2">Confirm Password</label>
						<input
							type="password"
							id="register-confirm"
							name="confirm"
							class="input-glass"
							placeholder="••••••••"
							minlength="8"
							required
						/>
					</div>

					<button
						type="submit"
						id="register-btn"
						class="w-full btn-glass btn-glass-primary py-3 flex items-center justify-center gap-2"
					>
						<span id="register-btn-text">Create Account</span>
						<svg id="register-btn-spinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
							<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
							<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
						</svg>
					</button>
				</form>

				<p id="demo-hint" class="mt-8 text-xs text-center text-white/30">
					Demo: admin@clawfi.io / clawfi123
				</p>
			</div>

			<p class="mt-8 text-xs text-center text-white/30">
				Your machine, your rules — runs on any OS.
			</p>
		</div>
	</div>
</LayoutCommon>

<script is:inline>
	sessionStorage.removeItem('clawfi_redirecting');
	var API_URL = 'https://api.clawfi.ai';

	var tabSignin = document.getElementById('tab-signin');
	var tabSignup = document.getElementById('tab-signup');
	var loginForm = document.getElementById('login-form');
	var registerForm = document.getElementById('register-form');
	var errorMessage = document.getElementById('error-message');
	var successMessage = document.getElementById('success-message');
	var demoHint = document.getElementById('demo-hint');

	function showSignIn() {
		tabSignin.className = 'flex-1 py-2.5 px-4 text-sm font-medium rounded-full transition-all btn-glass-primary';
		tabSignup.className = 'flex-1 py-2.5 px-4 text-sm font-medium rounded-full transition-all text-white/50 hover:text-white';
		loginForm.classList.remove('hidden');
		registerForm.classList.add('hidden');
		demoHint.classList.remove('hidden');
		hideMessages();
	}

	function showSignUp() {
		tabSignup.className = 'flex-1 py-2.5 px-4 text-sm font-medium rounded-full transition-all btn-glass-primary';
		tabSignin.className = 'flex-1 py-2.5 px-4 text-sm font-medium rounded-full transition-all text-white/50 hover:text-white';
		registerForm.classList.remove('hidden');
		loginForm.classList.add('hidden');
		demoHint.classList.add('hidden');
		hideMessages();
	}

	function hideMessages() {
		errorMessage.classList.add('hidden');
		successMessage.classList.add('hidden');
	}

	function showError(msg) {
		errorMessage.textContent = msg;
		errorMessage.classList.remove('hidden');
		successMessage.classList.add('hidden');
	}

	tabSignin.addEventListener('click', showSignIn);
	tabSignup.addEventListener('click', showSignUp);

	var loginBtn = document.getElementById('login-btn');
	var loginBtnText = document.getElementById('login-btn-text');
	var loginBtnSpinner = document.getElementById('login-btn-spinner');

	loginForm.addEventListener('submit', function(e) {
		e.preventDefault();
		var email = document.getElementById('login-email').value;
		var password = document.getElementById('login-password').value;

		loginBtn.disabled = true;
		loginBtnText.textContent = 'Signing in...';
		loginBtnSpinner.classList.remove('hidden');
		hideMessages();

		fetch(API_URL + '/auth/login', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ email: email, password: password })
		})
		.then(function(response) {
			return response.json().then(function(data) {
				return { ok: response.ok, data: data };
			});
		})
		.then(function(result) {
			if (!result.ok || !result.data.success) {
				throw new Error(result.data.error?.message || 'Login failed');
			}
			var token = result.data.data?.token || result.data.token;
			if (!token) throw new Error('No token received');
			localStorage.setItem('clawfi_token', token);
			window.location.href = '/';
		})
		.catch(function(error) {
			showError(error.message || 'Login failed');
			loginBtn.disabled = false;
			loginBtnText.textContent = 'Sign In';
			loginBtnSpinner.classList.add('hidden');
		});
	});

	var registerBtn = document.getElementById('register-btn');
	var registerBtnText = document.getElementById('register-btn-text');
	var registerBtnSpinner = document.getElementById('register-btn-spinner');

	registerForm.addEventListener('submit', function(e) {
		e.preventDefault();
		var name = document.getElementById('register-name').value;
		var email = document.getElementById('register-email').value;
		var password = document.getElementById('register-password').value;
		var confirm = document.getElementById('register-confirm').value;

		if (password !== confirm) {
			showError('Passwords do not match');
			return;
		}
		if (password.length < 8) {
			showError('Password must be at least 8 characters');
			return;
		}

		registerBtn.disabled = true;
		registerBtnText.textContent = 'Creating account...';
		registerBtnSpinner.classList.remove('hidden');
		hideMessages();

		fetch(API_URL + '/auth/register', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ email: email, password: password, name: name || undefined })
		})
		.then(function(response) {
			return response.json().then(function(data) {
				return { ok: response.ok, data: data };
			});
		})
		.then(function(result) {
			if (!result.ok || !result.data.success) {
				throw new Error(result.data.error?.message || 'Registration failed');
			}
			var token = result.data.data?.token || result.data.token;
			if (!token) throw new Error('No token received');
			localStorage.setItem('clawfi_token', token);
			window.location.href = '/';
		})
		.catch(function(error) {
			showError(error.message || 'Registration failed');
			registerBtn.disabled = false;
			registerBtnText.textContent = 'Create Account';
			registerBtnSpinner.classList.add('hidden');
		});
	});
</script>
