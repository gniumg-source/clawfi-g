---
import ColorModeSwitcher from '../components/ColorModeSwitcher.astro';
---

<nav class="fixed z-30 w-full glass-nav">
	<div class="px-4 py-3 lg:px-6">
		<div class="flex items-center justify-between">
			<div class="flex items-center gap-4">
				<!-- Mobile menu button -->
				<button
					id="toggleSidebarMobile"
					aria-expanded="true"
					aria-controls="sidebar"
					class="p-2 rounded-xl lg:hidden text-white/60 hover:text-white hover:bg-white/10 transition-all"
				>
					<svg id="toggleSidebarMobileHamburger" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
						<path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
					</svg>
					<svg id="toggleSidebarMobileClose" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
						<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
					</svg>
				</button>
				
				<!-- Logo -->
				<a href="/" class="flex items-center">
					<img src="/logo.png" alt="ClawFi" class="h-8 w-auto" />
				</a>

				<!-- Search - Glass pill -->
				<div class="hidden lg:block">
					<div class="relative">
						<div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
							<svg class="w-4 h-4 text-white/40" fill="currentColor" viewBox="0 0 20 20">
								<path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
							</svg>
						</div>
						<input
							type="text"
							id="topbar-search"
							class="input-glass w-80 pl-11 py-2.5 rounded-full text-sm"
							placeholder="Search tokens, wallets..."
						/>
					</div>
				</div>
			</div>

			<div class="flex items-center gap-3">
				<!-- Kill Switch - Glass badge (hidden by default via inline style) -->
				<div id="killswitch-indicator" class="items-center badge-glass badge-glass-red" style="display: none;">
					<span class="status-dot status-dot-offline mr-2"></span>
					<span class="text-sm font-medium">Kill Switch Active</span>
				</div>

				<!-- Mobile Search -->
				<button
					id="toggleSidebarMobileSearch"
					type="button"
					class="p-2 rounded-xl lg:hidden text-white/60 hover:text-white hover:bg-white/10 transition-all"
				>
					<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
						<path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
					</svg>
				</button>

				<!-- Notifications - Glass button -->
				<button
					type="button"
					data-dropdown-toggle="notification-dropdown"
					class="relative p-2.5 rounded-xl text-white/60 hover:text-white hover:bg-white/10 transition-all"
				>
					<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
						<path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
					</svg>
					<span id="notification-badge" class="hidden absolute top-1.5 right-1.5 w-2 h-2 bg-[#0A84FF] rounded-full"></span>
				</button>
				
				<!-- Notifications Dropdown - Elevated glass -->
				<div
					class="z-50 hidden max-w-sm glass-elevated overflow-hidden"
					id="notification-dropdown"
				>
					<div class="px-4 py-3 text-sm font-medium text-center border-b border-white/10">
						Recent Signals
					</div>
					<div id="notification-list" class="max-h-64 overflow-y-auto">
						<div class="px-4 py-6 text-sm text-white/40 text-center">
							No new signals
						</div>
					</div>
					<a
						href="/signals"
						class="block py-3 text-sm font-medium text-center text-[#0A84FF] border-t border-white/10 hover:bg-white/5 transition-all"
					>
						View all signals
					</a>
				</div>

				<ColorModeSwitcher />

				<!-- Profile - Glass avatar -->
				<div class="flex items-center ml-1">
					<button
						type="button"
						class="flex items-center p-1 rounded-full hover:bg-white/10 transition-all"
						id="user-menu-button-2"
						data-dropdown-toggle="dropdown-2"
					>
						<div class="w-9 h-9 rounded-full bg-gradient-to-br from-[#0A84FF] to-[#5856D6] flex items-center justify-center text-white font-semibold text-sm shadow-lg shadow-blue-500/30">
							A
						</div>
					</button>
					
					<!-- Profile Dropdown - Elevated glass -->
					<div
						class="z-50 hidden glass-elevated min-w-[200px] overflow-hidden"
						id="dropdown-2"
					>
						<div class="px-4 py-3 border-b border-white/10">
							<p class="text-sm text-white font-medium" id="user-name">Admin</p>
							<p class="text-xs text-white/50 truncate" id="user-email">admin@clawfi.io</p>
						</div>
						<div class="py-1">
							<a href="/" class="block px-4 py-2.5 text-sm text-white/80 hover:bg-white/5 hover:text-white transition-all">Dashboard</a>
							<a href="/settings" class="block px-4 py-2.5 text-sm text-white/80 hover:bg-white/5 hover:text-white transition-all">Settings</a>
							<a href="/audit" class="block px-4 py-2.5 text-sm text-white/80 hover:bg-white/5 hover:text-white transition-all">Audit Log</a>
							<button
								id="logout-btn"
								class="w-full text-left px-4 py-2.5 text-sm text-[#FF453A] hover:bg-red-500/10 transition-all"
							>
								Sign out
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</nav>

<script>
	document.getElementById('logout-btn')?.addEventListener('click', () => {
		if (typeof window.clawfiLogout === 'function') {
			window.clawfiLogout();
		} else {
			localStorage.removeItem('clawfi_token');
			window.location.replace('/login');
		}
	});

	const token = localStorage.getItem('clawfi_token');
	if (token) {
		// Fetch user info
		fetch('https://api.clawfi.ai/me', {
			headers: { 'Authorization': 'Bearer ' + token }
		}).then(res => res.json()).then(data => {
			if (data.success && data.data) {
				const nameEl = document.getElementById('user-name');
				const emailEl = document.getElementById('user-email');
				if (nameEl) nameEl.textContent = data.data.name || 'User';
				if (emailEl) emailEl.textContent = data.data.email || '';
			}
		}).catch(() => {});

		// Check kill switch status
		fetch('https://api.clawfi.ai/risk/policy', {
			headers: { 'Authorization': 'Bearer ' + token }
		}).then(res => res.json()).then(data => {
			const indicator = document.getElementById('killswitch-indicator');
			if (indicator && data.success && data.data) {
				if (data.data.killSwitchActive) {
					indicator.style.display = 'inline-flex';
				} else {
					indicator.style.display = 'none';
				}
			}
		}).catch(() => {});
	}
</script>
